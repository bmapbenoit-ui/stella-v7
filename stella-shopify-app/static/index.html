<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STELLA ‚Äî Plan√®teBeauty</title>
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js" data-api-key="__SHOPIFY_API_KEY__"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --gold: #C8984E; --gold-dim: rgba(200,152,78,0.15);
      --bg: #0B0B12; --surface: #13131D; --surface2: #1A1A28;
      --border: #222235; --text: #EAEAF2; --dim: #8888A0; --muted: #555570;
      --green: #22C55E; --red: #EF4444; --blue: #3B82F6;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
    #app { height: 100vh; display: flex; flex-direction: column; }

    .header { display:flex; align-items:center; gap:12px; padding:14px 20px; border-bottom:1px solid var(--border); background:var(--surface); flex-shrink:0; }
    .logo { width:34px; height:34px; border-radius:9px; background:linear-gradient(135deg,var(--gold),#8B6914); display:flex; align-items:center; justify-content:center; font-size:17px; color:#fff; font-weight:700; }
    .title { font-size:15px; font-weight:700; }
    .subtitle { font-size:11px; color:var(--dim); }
    .tabs { display:flex; gap:4px; margin-left:auto; }
    .tab { padding:5px 12px; border-radius:16px; border:1px solid var(--border); background:transparent; color:var(--dim); font-size:11px; font-weight:600; cursor:pointer; transition:all .15s; }
    .tab.active, .tab:hover { border-color:var(--gold); color:var(--gold); background:var(--gold-dim); }
    .status { display:flex; align-items:center; gap:6px; font-size:11px; margin-left:16px; }
    .dot { width:6px; height:6px; border-radius:50%; animation:pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

    .actions { display:flex; gap:6px; padding:10px 20px; border-bottom:1px solid var(--border); flex-shrink:0; overflow-x:auto; }
    .action { padding:5px 12px; border-radius:16px; border:1px solid var(--border); background:var(--surface); color:var(--dim); font-size:11px; cursor:pointer; white-space:nowrap; transition:all .15s; }
    .action:hover { border-color:var(--gold); color:var(--gold); }

    .messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:12px; }
    .messages::-webkit-scrollbar { width:5px; }
    .messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

    .msg { max-width:85%; padding:12px 16px; border-radius:14px; font-size:13px; line-height:1.6; animation:fadeIn .2s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
    .msg.user { align-self:flex-end; background:var(--gold); color:#0A0A0F; border-bottom-right-radius:4px; }
    .msg.stella { align-self:flex-start; background:var(--surface2); border:1px solid var(--border); border-bottom-left-radius:4px; }
    .msg.stella .meta { font-size:10px; color:var(--muted); margin-top:8px; display:flex; gap:10px; }
    .msg.system { align-self:center; background:var(--gold-dim); border:1px solid rgba(200,152,78,0.2); color:var(--gold); font-size:11px; border-radius:8px; }
    .msg pre { background:var(--bg); padding:8px 12px; border-radius:6px; overflow-x:auto; font-size:12px; margin:6px 0; }
    .msg code { font-family:'SF Mono',Consolas,monospace; font-size:12px; }
    .msg p { margin:4px 0; }
    .msg strong { color:var(--gold); }
    .msg ul, .msg ol { padding-left:20px; margin:4px 0; }
    .msg a { color:var(--blue); }

    .typing { align-self:flex-start; display:flex; gap:4px; padding:12px 16px; background:var(--surface2); border:1px solid var(--border); border-radius:14px; border-bottom-left-radius:4px; }
    .typing span { width:6px; height:6px; border-radius:50%; background:var(--dim); animation:bounce .6s infinite; }
    .typing span:nth-child(2) { animation-delay:.15s; }
    .typing span:nth-child(3) { animation-delay:.3s; }
    @keyframes bounce { 0%,100%{opacity:.3;transform:translateY(0)} 50%{opacity:1;transform:translateY(-4px)} }

    .input-area { padding:12px 20px 16px; border-top:1px solid var(--border); background:var(--surface); flex-shrink:0; }
    .input-row { display:flex; gap:8px; align-items:flex-end; }
    textarea { flex:1; resize:none; border:1px solid var(--border); background:var(--bg); color:var(--text); border-radius:12px; padding:10px 14px; font-size:13px; font-family:inherit; line-height:1.4; max-height:120px; outline:none; transition:border .15s; }
    textarea:focus { border-color:var(--gold); }
    textarea::placeholder { color:var(--muted); }
    .send { width:40px; height:40px; border-radius:10px; border:none; background:var(--gold); color:#0A0A0F; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:opacity .15s; }
    .send:disabled { opacity:.3; cursor:default; }

    .welcome { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; padding:40px; }
    .welcome-logo { width:64px; height:64px; border-radius:16px; background:linear-gradient(135deg,var(--gold),#8B6914); display:flex; align-items:center; justify-content:center; font-size:32px; color:#fff; }
    .welcome h2 { font-size:20px; font-weight:700; }
    .welcome p { font-size:13px; color:var(--dim); text-align:center; max-width:400px; line-height:1.6; }
    .welcome-actions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:8px; }
    .welcome-action { padding:8px 16px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--dim); font-size:12px; cursor:pointer; transition:all .15s; }
    .welcome-action:hover { border-color:var(--gold); color:var(--gold); background:var(--gold-dim); }
  </style>
</head>
<body>
<div id="app"></div>
<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SHOP = "__SHOPIFY_SHOP__";
const HOST = "__SHOPIFY_HOST__";
const PROJECTS = [
  { id: "FICHES_V6", label: "Fiches V6" },
  { id: "GENERAL", label: "G√©n√©ral" },
  { id: "MARKETING", label: "Marketing" },
];
const QUICK_ACTIONS = [
  { label: "üìä Stats queue", prompt: "Donne-moi les stats de la queue d'enrichissement : combien de produits total, enrichis, en attente, en erreur, par marque." },
  { label: "üîç Prochain produit", prompt: "Quel est le prochain produit √† enrichir dans la queue ? Donne son nom, sa marque et sa priorit√©." },
  { label: "üß† √âtat m√©moire", prompt: "R√©sume l'√©tat de ta m√©moire : combien de documents dans chaque niveau (court, moyen, long terme) ?" },
  { label: "üìã R√©sum√© projet", prompt: "Fais un r√©sum√© complet de l'avancement du projet en cours." },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHOPIFY APP BRIDGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sessionToken = null;

async function getSessionToken() {
  if (sessionToken) return sessionToken;
  try {
    if (window.shopify) {
      const token = await window.shopify.idToken();
      sessionToken = token;
      setTimeout(() => { sessionToken = null; }, 50000); // refresh before 60s expiry
      return token;
    }
  } catch(e) {
    console.warn("App Bridge token error:", e);
  }
  return null;
}

async function apiCall(path, opts = {}) {
  const token = await getSessionToken();
  const headers = { "Content-Type": "application/json" };
  if (token) headers["Authorization"] = `Bearer ${token}`;
  
  const res = await fetch(path, { ...opts, headers: { ...headers, ...opts.headers } });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKDOWN PARSER (simple)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarkdown(text) {
  if (!text) return "";
  let html = text
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/\n{2,}/g, '</p><p>')
    .replace(/\n/g, '<br>');
  return `<p>${html}</p>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT COMPONENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function StellaChat() {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState("");
  const [loading, setLoading] = useState(false);
  const [project, setProject] = useState("FICHES_V6");
  const [connected, setConnected] = useState(false);
  const messagesRef = useRef(null);
  const textareaRef = useRef(null);

  // Check connection on mount
  useEffect(() => {
    apiCall("/health")
      .then(() => setConnected(true))
      .catch(() => setConnected(false));
  }, []);

  // Auto-scroll
  useEffect(() => {
    if (messagesRef.current) {
      messagesRef.current.scrollTop = messagesRef.current.scrollHeight;
    }
  }, [messages, loading]);

  // Auto-resize textarea
  const handleInputChange = (e) => {
    setInput(e.target.value);
    e.target.style.height = "auto";
    e.target.style.height = Math.min(e.target.scrollHeight, 120) + "px";
  };

  const handleSend = useCallback(async (text) => {
    const msg = text || input.trim();
    if (!msg || loading) return;
    if (!text) setInput("");
    if (textareaRef.current) textareaRef.current.style.height = "auto";

    setMessages(prev => [...prev, { role: "user", content: msg, time: new Date() }]);
    setLoading(true);

    try {
      const data = await apiCall("/api/chat", {
        method: "POST",
        body: JSON.stringify({ message: msg, project }),
      });

      setMessages(prev => [...prev, {
        role: "stella",
        content: data.answer || data.error || "Pas de r√©ponse",
        llm: data.llm_used,
        rag: data.rag_context,
        time: new Date(),
      }]);
    } catch (err) {
      setMessages(prev => [...prev, {
        role: "system",
        content: `Erreur: ${err.message}`,
        time: new Date(),
      }]);
    } finally {
      setLoading(false);
    }
  }, [input, loading, project]);

  const handleKeyDown = (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  return (
    <div id="app" style={{ height: "100vh", display: "flex", flexDirection: "column" }}>
      {/* HEADER */}
      <div className="header">
        <div className="logo">‚òÖ</div>
        <div>
          <div className="title">STELLA V7</div>
          <div className="subtitle">Cerveau IA ‚Äî Plan√®teBeauty</div>
        </div>
        <div className="tabs">
          {PROJECTS.map(p => (
            <button key={p.id} className={`tab ${project === p.id ? "active" : ""}`}
              onClick={() => setProject(p.id)}>{p.label}</button>
          ))}
        </div>
        <div className="status">
          <span className="dot" style={{ background: connected ? "var(--green)" : "var(--red)" }} />
          <span style={{ color: connected ? "var(--green)" : "var(--red)" }}>
            {connected ? "Connect√©e" : "Hors ligne"}
          </span>
        </div>
      </div>

      {/* QUICK ACTIONS */}
      <div className="actions">
        {QUICK_ACTIONS.map((a, i) => (
          <button key={i} className="action" onClick={() => handleSend(a.prompt)} disabled={loading}>
            {a.label}
          </button>
        ))}
      </div>

      {/* MESSAGES or WELCOME */}
      {messages.length === 0 ? (
        <div className="welcome">
          <div className="welcome-logo">‚òÖ</div>
          <h2>Bonjour, Benoit</h2>
          <p>Je suis STELLA, le cerveau IA de Plan√®teBeauty. Je me souviens de tout et je g√®re tes projets. Pose-moi une question ou utilise les actions rapides.</p>
          <div className="welcome-actions">
            {QUICK_ACTIONS.map((a, i) => (
              <button key={i} className="welcome-action" onClick={() => handleSend(a.prompt)}>
                {a.label}
              </button>
            ))}
          </div>
        </div>
      ) : (
        <div className="messages" ref={messagesRef}>
          {messages.map((msg, i) => (
            <div key={i} className={`msg ${msg.role}`}>
              {msg.role === "stella" ? (
                <>
                  <div dangerouslySetInnerHTML={{ __html: renderMarkdown(msg.content) }} />
                  <div className="meta">
                    <span>üß† {msg.llm || "mistral"}</span>
                    {msg.rag && <span>üìö RAG</span>}
                    <span>{msg.time?.toLocaleTimeString("fr-FR", {hour:"2-digit",minute:"2-digit"})}</span>
                  </div>
                </>
              ) : (
                <span>{msg.content}</span>
              )}
            </div>
          ))}
          {loading && (
            <div className="typing">
              <span /><span /><span />
            </div>
          )}
        </div>
      )}

      {/* INPUT */}
      <div className="input-area">
        <div className="input-row">
          <textarea
            ref={textareaRef}
            placeholder="Parle √† STELLA..."
            value={input}
            onChange={handleInputChange}
            onKeyDown={handleKeyDown}
            rows={1}
            disabled={loading}
          />
          <button className="send" onClick={() => handleSend()} disabled={loading || !input.trim()}>
            ‚û§
          </button>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("app")).render(<StellaChat />);
</script>
</body>
</html>
