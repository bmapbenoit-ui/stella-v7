<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STELLA â€” PlanÃ¨teBeauty</title>

  <!-- Shopify App Bridge CDN (auto-updates) -->
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"
          data-api-key="__SHOPIFY_API_KEY__"></script>

  <!-- Polaris CSS -->
  <link rel="stylesheet" href="https://unpkg.com/@shopify/polaris@13.9.0/build/esm/styles.css">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --stella-gold: #C8984E;
      --stella-gold-dim: rgba(200, 152, 78, 0.15);
      --stella-dark: #0A0A0F;
      --stella-surface: #12121A;
      --stella-border: #1E1E2E;
      --stella-text: #E8E8F0;
      --stella-text-dim: #8888A0;
      --stella-green: #22C55E;
      --stella-red: #EF4444;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: var(--stella-dark);
      color: var(--stella-text);
      height: 100vh;
      overflow: hidden;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* HEADER */
    .stella-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      border-bottom: 1px solid var(--stella-border);
      background: var(--stella-surface);
      flex-shrink: 0;
    }

    .stella-logo {
      width: 36px; height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--stella-gold), #8B6914);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: white; font-weight: bold;
    }

    .stella-title { font-size: 16px; font-weight: 700; }
    .stella-subtitle { font-size: 11px; color: var(--stella-text-dim); }

    .stella-status {
      margin-left: auto;
      display: flex; align-items: center; gap: 6px;
      font-size: 11px; color: var(--stella-green);
    }

    .stella-status-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--stella-green);
      animation: pulse 2s infinite;
    }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

    /* QUICK ACTIONS */
    .stella-actions {
      display: flex; gap: 8px; padding: 12px 20px;
      border-bottom: 1px solid var(--stella-border);
      overflow-x: auto; flex-shrink: 0;
    }

    .stella-action-btn {
      padding: 6px 14px;
      border-radius: 20px;
      border: 1px solid var(--stella-border);
      background: var(--stella-surface);
      color: var(--stella-text-dim);
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .stella-action-btn:hover {
      border-color: var(--stella-gold);
      color: var(--stella-gold);
      background: var(--stella-gold-dim);
    }

    /* MESSAGES */
    .stella-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .stella-msg {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.6;
      animation: msgIn 0.3s ease;
      white-space: pre-wrap;
      word-break: break-word;
    }

    @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } }

    .stella-msg.user {
      align-self: flex-end;
      background: var(--stella-gold);
      color: #000;
      border-bottom-right-radius: 4px;
    }

    .stella-msg.assistant {
      align-self: flex-start;
      background: var(--stella-surface);
      border: 1px solid var(--stella-border);
      border-bottom-left-radius: 4px;
    }

    .stella-msg.system {
      align-self: center;
      background: var(--stella-gold-dim);
      border: 1px solid rgba(200,152,78,0.3);
      color: var(--stella-gold);
      font-size: 12px;
      text-align: center;
      max-width: 90%;
    }

    .stella-msg-meta {
      font-size: 10px;
      color: var(--stella-text-dim);
      margin-top: 4px;
    }

    .stella-typing {
      display: flex; gap: 4px; padding: 12px 16px;
      background: var(--stella-surface);
      border: 1px solid var(--stella-border);
      border-radius: 14px;
      align-self: flex-start;
      animation: msgIn 0.3s ease;
    }

    .stella-typing-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--stella-gold);
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .stella-typing-dot:nth-child(1) { animation-delay: 0s; }
    .stella-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .stella-typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.3; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* INPUT */
    .stella-input-area {
      padding: 16px 20px;
      border-top: 1px solid var(--stella-border);
      background: var(--stella-surface);
      flex-shrink: 0;
    }

    .stella-input-row {
      display: flex; gap: 10px; align-items: flex-end;
    }

    .stella-textarea {
      flex: 1;
      background: var(--stella-dark);
      border: 1px solid var(--stella-border);
      border-radius: 12px;
      padding: 12px 16px;
      color: var(--stella-text);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
      min-height: 44px;
      max-height: 120px;
      transition: border-color 0.2s;
    }

    .stella-textarea:focus {
      border-color: var(--stella-gold);
    }

    .stella-textarea::placeholder {
      color: var(--stella-text-dim);
    }

    .stella-send-btn {
      width: 44px; height: 44px;
      border-radius: 12px;
      border: none;
      background: var(--stella-gold);
      color: #000;
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .stella-send-btn:hover { transform: scale(1.05); }
    .stella-send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    /* PROJECT TABS */
    .stella-projects {
      display: flex; gap: 4px;
      margin-left: auto;
    }

    .stella-project-tab {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--stella-text-dim);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .stella-project-tab.active {
      border-color: var(--stella-gold);
      color: var(--stella-gold);
      background: var(--stella-gold-dim);
    }

    /* SCROLLBAR */
    .stella-messages::-webkit-scrollbar { width: 6px; }
    .stella-messages::-webkit-scrollbar-track { background: transparent; }
    .stella-messages::-webkit-scrollbar-thumb { background: var(--stella-border); border-radius: 3px; }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- React + ReactDOM CDN -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIG
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const CONFIG = {
      apiKey: "__SHOPIFY_API_KEY__",
      shop: "__SHOPIFY_SHOP__",
      host: "__SHOPIFY_HOST__",
    };

    const PROJECTS = [
      { id: "GENERAL", label: "GÃ©nÃ©ral" },
      { id: "FICHES_V6", label: "Fiches V6" },
      { id: "MARKETING", label: "Marketing" },
      { id: "FINANCE", label: "Finance" },
    ];

    const QUICK_ACTIONS = [
      { label: "ğŸ“Š Stats queue", prompt: "Donne-moi les statistiques de la file d'attente produits : combien complÃ©tÃ©s, en attente, erreurs, par marque prioritaire." },
      { label: "ğŸ·ï¸ Marques", prompt: "Liste les marques prioritaires avec leur nombre de produits et leur taux de complÃ©tion." },
      { label: "ğŸ“‹ RÃ©sumÃ© jour", prompt: "Fais un rÃ©sumÃ© de ce qui a Ã©tÃ© fait aujourd'hui : produits enrichis, dÃ©cisions prises, problÃ¨mes rencontrÃ©s." },
      { label: "ğŸ” Prochain produit", prompt: "Quel est le prochain produit Ã  enrichir dans la queue ? Donne-moi ses dÃ©tails." },
      { label: "ğŸ§  MÃ©moire", prompt: "RÃ©sume ce que tu sais : combien de produits indexÃ©s, quelles leÃ§ons apprises, quelles dÃ©cisions stratÃ©giques mÃ©morisÃ©es." },
      { label: "ğŸ’° CA & objectifs", prompt: "OÃ¹ en est-on par rapport Ã  l'objectif de 925Kâ‚¬ ? Rappelle les derniers chiffres et le MER." },
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API CALLS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function getSessionToken() {
      // App Bridge automatically provides session token via shopify global
      if (window.shopify) {
        try {
          const token = await window.shopify.idToken();
          return token;
        } catch (e) {
          console.warn("Could not get session token:", e);
        }
      }
      return null;
    }

    async function apiCall(endpoint, options = {}) {
      const token = await getSessionToken();
      const headers = {
        "Content-Type": "application/json",
        ...(token ? { "Authorization": `Bearer ${token}` } : {}),
      };

      const resp = await fetch(endpoint, {
        ...options,
        headers: { ...headers, ...options.headers },
      });

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: resp.statusText }));
        throw new Error(err.detail || "API error");
      }

      return resp.json();
    }

    async function sendChat(message, project) {
      return apiCall("/api/chat", {
        method: "POST",
        body: JSON.stringify({ message, project }),
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPONENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function Message({ msg }) {
      return (
        <div className={`stella-msg ${msg.role}`}>
          <div>{msg.content}</div>
          {msg.meta && <div className="stella-msg-meta">{msg.meta}</div>}
        </div>
      );
    }

    function TypingIndicator() {
      return (
        <div className="stella-typing">
          <div className="stella-typing-dot" />
          <div className="stella-typing-dot" />
          <div className="stella-typing-dot" />
        </div>
      );
    }

    function StellaChat() {
      const [messages, setMessages] = useState([
        {
          role: "system",
          content: "â˜… STELLA V7 connectÃ©e â€” Cerveau IA PlanÃ¨teBeauty",
        },
        {
          role: "assistant",
          content: "Bonjour Benoit ! Je suis STELLA, ton assistante IA pour PlanÃ¨teBeauty.\n\nJe me souviens de tout : 337 produits dans le catalogue, 49 marques, le template V6 pour les fiches produit, les dÃ©cisions stratÃ©giques...\n\nComment puis-je t'aider ?",
          meta: "Mistral API Â· mÃ©moire 3 niveaux active",
        },
      ]);
      const [input, setInput] = useState("");
      const [loading, setLoading] = useState(false);
      const [project, setProject] = useState("FICHES_V6");
      const [connected, setConnected] = useState(true);
      const messagesRef = useRef(null);
      const textareaRef = useRef(null);

      // Auto-scroll
      useEffect(() => {
        if (messagesRef.current) {
          messagesRef.current.scrollTop = messagesRef.current.scrollHeight;
        }
      }, [messages, loading]);

      // Auto-resize textarea
      const handleInputChange = (e) => {
        setInput(e.target.value);
        const ta = textareaRef.current;
        if (ta) {
          ta.style.height = "auto";
          ta.style.height = Math.min(ta.scrollHeight, 120) + "px";
        }
      };

      // Send message
      const handleSend = useCallback(async (overrideMsg) => {
        const msg = overrideMsg || input.trim();
        if (!msg || loading) return;

        if (!overrideMsg) setInput("");
        if (textareaRef.current) textareaRef.current.style.height = "auto";

        // Add user message
        setMessages(prev => [...prev, { role: "user", content: msg }]);
        setLoading(true);

        try {
          const startTime = Date.now();
          const resp = await sendChat(msg, project);
          const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

          setMessages(prev => [...prev, {
            role: "assistant",
            content: resp.answer || resp.response || "Pas de rÃ©ponse.",
            meta: `${resp.llm_used || "mistral"} Â· ${elapsed}s Â· projet: ${project}`,
          }]);
          setConnected(true);
        } catch (err) {
          setMessages(prev => [...prev, {
            role: "system",
            content: `âš ï¸ Erreur: ${err.message}`,
          }]);
          setConnected(false);
        } finally {
          setLoading(false);
        }
      }, [input, loading, project]);

      // Enter to send
      const handleKeyDown = (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      };

      return (
        <div id="app" style={{ display: "flex", flexDirection: "column", height: "100vh" }}>
          {/* HEADER */}
          <div className="stella-header">
            <div className="stella-logo">â˜…</div>
            <div>
              <div className="stella-title">STELLA V7</div>
              <div className="stella-subtitle">Cerveau IA â€” PlanÃ¨teBeauty</div>
            </div>
            <div className="stella-projects">
              {PROJECTS.map(p => (
                <button
                  key={p.id}
                  className={`stella-project-tab ${project === p.id ? "active" : ""}`}
                  onClick={() => setProject(p.id)}
                >
                  {p.label}
                </button>
              ))}
            </div>
            <div className="stella-status">
              <span className="stella-status-dot" style={{
                background: connected ? "var(--stella-green)" : "var(--stella-red)"
              }} />
              {connected ? "ConnectÃ©e" : "DÃ©connectÃ©e"}
            </div>
          </div>

          {/* QUICK ACTIONS */}
          <div className="stella-actions">
            {QUICK_ACTIONS.map((a, i) => (
              <button
                key={i}
                className="stella-action-btn"
                onClick={() => handleSend(a.prompt)}
                disabled={loading}
              >
                {a.label}
              </button>
            ))}
          </div>

          {/* MESSAGES */}
          <div className="stella-messages" ref={messagesRef}>
            {messages.map((msg, i) => (
              <Message key={i} msg={msg} />
            ))}
            {loading && <TypingIndicator />}
          </div>

          {/* INPUT */}
          <div className="stella-input-area">
            <div className="stella-input-row">
              <textarea
                ref={textareaRef}
                className="stella-textarea"
                placeholder="Parle Ã  STELLA..."
                value={input}
                onChange={handleInputChange}
                onKeyDown={handleKeyDown}
                rows={1}
                disabled={loading}
              />
              <button
                className="stella-send-btn"
                onClick={() => handleSend()}
                disabled={loading || !input.trim()}
              >
                â¤
              </button>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MOUNT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ReactDOM.createRoot(document.getElementById("app")).render(<StellaChat />);
  </script>
</body>
</html>
